<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AquaVerse - Left Sidebar Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #e0e7ff;
            font-family: sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        canvas {
            touch-action: none;
        }

        /* Ch·∫∑n cu·ªôn trang khi xoay 3D */

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .item-card:active {
            transform: scale(0.95);
            border-color: #40916c;
        }

        .active-tab {
            background-color: #40916c;
            color: white;
        }

        .inactive-tab {
            background-color: white;
            color: #64748b;
        }

        .tool-btn.active {
            background-color: #40916c;
            color: white;
            border-color: #40916c;
        }

        /* === LOGIC SIDEBAR TR∆Ø·ª¢T T·ª™ TR√ÅI QUA === */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        /* M·∫∑c ƒë·ªãnh tr√™n mobile l√† ·∫©n sang tr√°i (-100%) */
        .sidebar-closed {
            transform: translateX(-100%);
        }

        .sidebar-open {
            transform: translateX(0);
        }

        /* Tr√™n Desktop (md) th√¨ lu√¥n hi·ªán (reset transform) */
        @media (min-width: 768px) {
            .sidebar-closed {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>

    <div class="relative h-screen w-screen overflow-hidden flex">

        <button onclick="toggleSidebar()"
            class="md:hidden absolute top-4 left-4 z-50 w-10 h-10 bg-white rounded-lg shadow-lg text-[#2d6a4f] flex items-center justify-center active:bg-gray-100">
            <i class="fa-solid fa-bars text-xl"></i>
        </button>

        <div id="sidebar"
            class="fixed inset-y-0 left-0 w-72 bg-white shadow-2xl z-40 flex flex-col border-r border-gray-200 sidebar-closed md:relative md:transform-none">

            <div class="p-4 border-b bg-white flex justify-between items-center mt-12 md:mt-0">
                <h1 class="text-xl font-bold text-[#2d6a4f] flex items-center gap-2">
                    <i class="fa-solid fa-cube"></i> Aqua Designer
                </h1>
                <button onclick="toggleSidebar()"
                    class="md:hidden text-gray-400 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
            </div>

            <div class="flex p-2 gap-2 bg-gray-100">
                <button onclick="switchTab('fish')" id="tab-fish"
                    class="active-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition">C√°</button>
                <button onclick="switchTab('plants')" id="tab-plants"
                    class="inactive-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition">C√¢y</button>
                <button onclick="switchTab('hardscape')" id="tab-hardscape"
                    class="inactive-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition">ƒê√°</button>
            </div>

            <div id="item-grid" class="flex-1 overflow-y-auto p-3 grid grid-cols-2 gap-3 content-start bg-[#f8fafc]">
            </div>

            <div class="p-4 bg-white border-t border-gray-200">
                <button onclick="clearScene()"
                    class="w-full py-3 bg-red-100 text-red-600 rounded-xl text-sm font-bold hover:bg-red-200 transition active:scale-95">
                    <i class="fa-solid fa-trash-can mr-2"></i> X√≥a t·∫•t c·∫£
                </button>
            </div>
        </div>

        <div class="flex-1 relative w-full h-full bg-[#e0e7ff]">

            <div id="canvas-container" class="w-full h-full"></div>

            <div
                class="absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-lg text-xs text-gray-600 pointer-events-none select-none z-20 border border-gray-100 text-right">
                <p class="hidden md:block"><i class="fa-solid fa-mouse text-[#40916c]"></i> Click ch·ªçn v·∫≠t th·ªÉ</p>
                <p class="md:hidden">üëÜ Ch·∫°m ƒë·ªÉ ch·ªçn</p>
                <p class="md:hidden">‚úåÔ∏è 2 ng√≥n xoay/zoom</p>
            </div>

            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-white rounded-2xl shadow-2xl p-2 flex gap-4 z-30 border border-gray-100 items-end"
                id="transform-toolbar" style="display:none;">

                <div class="flex flex-col items-center gap-1">
                    <button onclick="setTransformMode('translate')" id="btn-translate"
                        class="tool-btn active w-12 h-12 rounded-2xl border border-gray-200 flex items-center justify-center shadow-sm active:scale-90 touch-manipulation">
                        <i class="fa-solid fa-arrows-up-down-left-right text-lg"></i>
                    </button>
                    <span class="text-[9px] text-gray-500 font-bold uppercase">D·ªùi</span>
                </div>

                <div class="flex flex-col items-center gap-1">
                    <button onclick="setTransformMode('scale')" id="btn-scale"
                        class="tool-btn w-12 h-12 rounded-2xl border border-gray-200 flex items-center justify-center shadow-sm active:scale-90 touch-manipulation">
                        <i class="fa-solid fa-expand text-lg"></i>
                    </button>
                    <span class="text-[9px] text-gray-500 font-bold uppercase">Size</span>
                </div>

                <div class="w-[1px] h-12 bg-gray-200 mx-1"></div>

                <div class="flex flex-col items-center gap-1">
                    <button onclick="deleteSelected()"
                        class="tool-btn w-12 h-12 rounded-2xl border border-red-100 text-red-500 flex items-center justify-center bg-red-50 shadow-sm active:scale-90 touch-manipulation">
                        <i class="fa-solid fa-trash-can text-lg"></i>
                    </button>
                    <span class="text-[9px] text-red-400 font-bold uppercase">X√≥a</span>
                </div>
            </div>

            <div id="overlay" onclick="toggleSidebar()"
                class="absolute inset-0 bg-black/30 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';

        // --- 1. D·ªÆ LI·ªÜU ITEM ---
        const db = {
            fish: [
                { name: 'Betta', img: './img/87c4fe2aa6611262bf263158b7eb84f4-removebg-preview (1).png', scale: 0.5 },
                { name: 'Goldfish', img: 'https://cdn-icons-png.flaticon.com/512/2970/2970078.png', scale: 0.6 },
                { name: 'Neon', img: 'https://cdn-icons-png.flaticon.com/512/10216/10216626.png', scale: 0.3 },
                { name: 'Koi', img: 'https://cdn-icons-png.flaticon.com/512/616/616566.png', scale: 0.8 },
            ],
            plants: [
                { name: 'R√°y', img: './img/S7735585ed90048c5921ad8ad9614142b9-removebg-preview (1).png', scale: 0.8 },
                { name: 'D∆∞∆°ng X·ªâ', img: 'https://cdn-icons-png.flaticon.com/512/2293/2293878.png', scale: 0.9 },
                { name: 'Rong', img: 'https://cdn-icons-png.flaticon.com/512/15043/15043277.png', scale: 1.0 },
            ],
            hardscape: [
                { name: 'ƒê√°', img: './img/536634efa35a8402e407da024efd445b-removebg-preview (1).png', scale: 0.6 },
                { name: 'L≈©a', img: 'https://cdn-icons-png.flaticon.com/512/12481/12481228.png', scale: 1.2 },
                { name: 'L√¢u ƒë√†i', img: 'https://cdn-icons-png.flaticon.com/512/2203/2203956.png', scale: 1.5 },
            ]
        };

        // --- 2. LOGIC SIDEBAR TR√ÅI ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            if (sidebar.classList.contains('sidebar-closed')) {
                // M·ªü menu
                sidebar.classList.remove('sidebar-closed');
                sidebar.classList.add('sidebar-open');
                overlay.classList.remove('hidden');
            } else {
                // ƒê√≥ng menu
                sidebar.classList.add('sidebar-closed');
                sidebar.classList.remove('sidebar-open');
                overlay.classList.add('hidden');
            }
        };

        // --- 3. RENDER ITEMS ---
        const grid = document.getElementById('item-grid');
        let currentCategory = 'fish';
        let itemsInScene = [];

        window.switchTab = (category) => {
            currentCategory = category;
            renderGrid();
            ['fish', 'plants', 'hardscape'].forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                btn.className = (c === category) ? 'active-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition' : 'inactive-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition';
            });
        };

        function renderGrid() {
            grid.innerHTML = '';
            db[currentCategory].forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card bg-white p-2 rounded-xl border border-gray-200 cursor-pointer flex flex-col items-center transition shadow-sm active:bg-gray-50';
                div.innerHTML = `<div class="h-12 w-full flex items-center justify-center mb-1"><img src="${item.img}" class="max-h-full object-contain pointer-events-none"></div><span class="text-[10px] font-semibold text-gray-700">${item.name}</span>`;

                div.onclick = (e) => {
                    e.stopPropagation();
                    addItemToScene(item, currentCategory);
                    // N·∫øu ƒëang ·ªü mobile (<768px), ch·ªçn xong th√¨ ƒë√≥ng menu ƒë·ªÉ xem k·∫øt qu·∫£
                    if (window.innerWidth < 768) window.toggleSidebar();
                };
                grid.appendChild(div);
            });
        }
        renderGrid();

        // --- 4. THREE.JS SCENE SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe0e7ff);
        scene.fog = new THREE.Fog(0xe0e7ff, 5, 30);

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(5, 4, 8);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.setPixelRatio(window.devicePixelRatio); // N√©t h∆°n tr√™n mobile
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.05;
        controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Tank
        const tankGroup = new THREE.Group();
        scene.add(tankGroup);
        const glassMat = new THREE.MeshPhysicalMaterial({ color: 0xaaccff, metalness: 0.1, roughness: 0, transmission: 0.6, transparent: true, side: THREE.BackSide });
        const tank = new THREE.Mesh(new THREE.BoxGeometry(6, 3, 3), glassMat);
        tank.position.y = 1.5;
        tankGroup.add(tank);
        const sand = new THREE.Mesh(new THREE.PlaneGeometry(5.8, 2.8), new THREE.MeshStandardMaterial({ color: 0x2f2f2f }));
        sand.rotation.x = -Math.PI / 2;
        sand.position.y = 0.02;
        sand.receiveShadow = true;
        tankGroup.add(sand);

        // --- 5. TRANSFORM CONTROLS (K√©o th·∫£) ---
        const transformControl = new TransformControls(camera, renderer.domElement);
        transformControl.setTranslationSnap(0.1);
        transformControl.setSize(2.0); // N√∫t k√©o to h∆°n cho d·ªÖ b·∫•m tr√™n mobile
        scene.add(transformControl);

        transformControl.addEventListener('dragging-changed', function (event) {
            controls.enabled = !event.value;
            if (transformControl.object) {
                transformControl.object.userData.isDragging = event.value;
            }
        });

        // --- 6. RAYCASTER (Ch·ªçn v·∫≠t th·ªÉ) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('pointerdown', (event) => {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(itemsInScene);

            if (intersects.length > 0) {
                const selectedObject = intersects[0].object;
                transformControl.attach(selectedObject);
                document.getElementById('transform-toolbar').style.display = 'flex';
            } else {
                if (!transformControl.dragging) {
                    transformControl.detach();
                    document.getElementById('transform-toolbar').style.display = 'none';
                }
            }
        });

        // Interface Functions
        window.setTransformMode = (mode) => {
            transformControl.setMode(mode);
            document.getElementById('btn-translate').classList.remove('active');
            document.getElementById('btn-scale').classList.remove('active');
            document.getElementById(`btn-${mode}`).classList.add('active');
        }

        window.deleteSelected = () => {
            if (transformControl.object) {
                const obj = transformControl.object;
                transformControl.detach();
                scene.remove(obj);
                const index = itemsInScene.indexOf(obj);
                if (index > -1) itemsInScene.splice(index, 1);
                document.getElementById('transform-toolbar').style.display = 'none';
            }
        }

        // --- 7. ADD & ANIMATE ---
        const textureLoader = new THREE.TextureLoader();
        window.addItemToScene = (itemData, type) => {
            textureLoader.load(itemData.img, (texture) => {
                const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide, alphaTest: 0.5 });
                const geometry = new THREE.PlaneGeometry(itemData.scale, itemData.scale);
                const mesh = new THREE.Mesh(geometry, material);

                const x = (Math.random() - 0.5) * 4;
                const z = (Math.random() - 0.5) * 2;

                if (type === 'fish') {
                    mesh.position.set(x, Math.random() * 1.5 + 0.5, z);
                    mesh.userData = { isFish: true, speed: (Math.random() * 0.02) + 0.005, direction: Math.random() > 0.5 ? 1 : -1, baseY: mesh.position.y };
                    if (mesh.userData.direction === -1) mesh.scale.x = -1;
                } else {
                    mesh.position.set(x, itemData.scale / 2, z);
                    mesh.userData = { isStatic: true };
                }

                mesh.castShadow = true;
                scene.add(mesh);
                itemsInScene.push(mesh);
                transformControl.attach(mesh);
                document.getElementById('transform-toolbar').style.display = 'flex';
            });
        };

        window.clearScene = () => {
            itemsInScene.forEach(m => scene.remove(m));
            itemsInScene = [];
            transformControl.detach();
            document.getElementById('transform-toolbar').style.display = 'none';
            if (window.innerWidth < 768) window.toggleSidebar();
        }

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            const time = clock.getElapsedTime();

            itemsInScene.forEach(mesh => {
                if (!mesh.userData.isDragging) {
                    if (mesh.userData.isFish) {
                        mesh.position.x += mesh.userData.speed * mesh.userData.direction;
                        if (!transformControl.object || transformControl.object !== mesh) {
                            mesh.position.y = (mesh.position.y * 0.95) + ((mesh.userData.baseY + Math.sin(time * 2 + mesh.id) * 0.1) * 0.05);
                        }
                        if (mesh.position.x > 2.8 || mesh.position.x < -2.8) {
                            mesh.userData.direction *= -1;
                            mesh.scale.x *= -1;
                        }
                        mesh.lookAt(camera.position);
                    }
                    if (mesh.userData.isStatic) {
                        const target = camera.position.clone();
                        target.y = mesh.position.y;
                        mesh.lookAt(target);
                    }
                } else {
                    if (mesh.userData.isFish) {
                        mesh.userData.baseY = mesh.position.y;
                        mesh.lookAt(camera.position);
                    }
                    if (mesh.userData.isStatic) {
                        const target = camera.position.clone();
                        target.y = mesh.position.y;
                        mesh.lookAt(target);
                    }
                }
            });
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });
        animate();
    </script>
</body>

</html>