<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaVerse - Interactive Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #e0e7ff;
            font-family: sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .item-card:hover {
            transform: translateY(-2px);
            border-color: #40916c;
        }

        .active-tab {
            background-color: #40916c;
            color: white;
        }

        .inactive-tab {
            background-color: white;
            color: #64748b;
        }

        /* Active Tool Button */
        .tool-btn.active {
            background-color: #40916c;
            color: white;
            border-color: #40916c;
        }
    </style>
</head>

<body>

    <div class="flex h-screen w-screen">

        <div class="w-80 bg-gray-50 flex flex-col shadow-2xl z-10 border-r border-gray-200 h-full flex-shrink-0">
            <div class="p-4 border-b bg-white">
                <h1 class="text-xl font-bold text-[#2d6a4f] flex items-center gap-2">
                    <i class="fa-solid fa-cube"></i> Aqua Designer
                </h1>
            </div>
            <div class="flex p-2 gap-2 bg-gray-100">
                <button onclick="switchTab('fish')" id="tab-fish"
                    class="active-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition">C√°</button>
                <button onclick="switchTab('plants')" id="tab-plants"
                    class="inactive-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition">C√¢y</button>
                <button onclick="switchTab('hardscape')" id="tab-hardscape"
                    class="inactive-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition">ƒê√°/L≈©a</button>
            </div>
            <div id="item-grid" class="flex-1 overflow-y-auto p-3 grid grid-cols-2 gap-3 content-start bg-[#f8fafc]">
            </div>
            <div class="p-4 bg-white border-t border-gray-200">
                <button onclick="clearScene()"
                    class="w-full py-2 bg-red-100 text-red-600 rounded-lg text-sm font-bold hover:bg-red-200 transition">
                    <i class="fa-solid fa-trash-can mr-2"></i> X√≥a t·∫•t c·∫£
                </button>
            </div>
        </div>

        <div class="flex-1 relative" id="canvas-container">

            <div
                class="absolute top-4 right-4 bg-white/80 backdrop-blur px-4 py-2 rounded-lg shadow text-xs text-gray-600 pointer-events-none select-none z-20">
                <p>üñ±Ô∏è <strong>Click</strong> v√†o v·∫≠t th·ªÉ ƒë·ªÉ ch·ªçn</p>
                <p>üîÑ <strong>Xoay n·ªÅn:</strong> Chu·ªôt tr√°i ra ngo√†i</p>
            </div>

            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-white rounded-full shadow-xl p-2 flex gap-2 z-20"
                id="transform-toolbar" style="display:none;">
                <button onclick="setTransformMode('translate')" id="btn-translate"
                    class="tool-btn active w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center hover:bg-gray-100 transition"
                    title="Di chuy·ªÉn">
                    <i class="fa-solid fa-arrows-up-down-left-right"></i>
                </button>
                <button onclick="setTransformMode('scale')" id="btn-scale"
                    class="tool-btn w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center hover:bg-gray-100 transition"
                    title="Ph√≥ng to / Thu nh·ªè">
                    <i class="fa-solid fa-expand"></i>
                </button>
                <div class="w-[1px] h-10 bg-gray-200"></div>
                <button onclick="deleteSelected()"
                    class="w-10 h-10 rounded-full border border-red-200 text-red-500 flex items-center justify-center hover:bg-red-50 transition"
                    title="X√≥a v·∫≠t th·ªÉ n√†y">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js'; // Import c√¥ng c·ª• k√©o th·∫£

        // --- D·ªÆ LI·ªÜU ---
        const db = {
            fish: [
                { name: 'Betta Red', img: 'https://cdn-icons-png.flaticon.com/512/3094/3094936.png', scale: 0.5 },
                { name: 'Goldfish', img: 'https://cdn-icons-png.flaticon.com/512/2970/2970078.png', scale: 0.6 },
                { name: 'Neon Tetra', img: 'https://cdn-icons-png.flaticon.com/512/10216/10216626.png', scale: 0.3 },
                { name: 'Koi Fish', img: 'https://cdn-icons-png.flaticon.com/512/616/616566.png', scale: 0.8 },
            ],
            plants: [
                { name: 'R√°y Nana', img: 'https://cdn-icons-png.flaticon.com/512/6768/6768548.png', scale: 0.8 },
                { name: 'D∆∞∆°ng X·ªâ', img: 'https://cdn-icons-png.flaticon.com/512/2293/2293878.png', scale: 0.9 },
                { name: 'Rong ƒêu√¥i Ch√≥', img: 'https://cdn-icons-png.flaticon.com/512/15043/15043277.png', scale: 1.0 },
            ],
            hardscape: [
                { name: 'ƒê√° Cu·ªôi', img: 'https://cdn-icons-png.flaticon.com/512/9249/9249660.png', scale: 0.6 },
                { name: 'L≈©a Bonsai', img: 'https://cdn-icons-png.flaticon.com/512/12481/12481228.png', scale: 1.2 },
                { name: 'L√¢u ƒë√†i', img: 'https://cdn-icons-png.flaticon.com/512/2203/2203956.png', scale: 1.5 },
            ]
        };

        // --- UI LOGIC ---
        const grid = document.getElementById('item-grid');
        let currentCategory = 'fish';
        let itemsInScene = [];

        window.switchTab = (category) => {
            currentCategory = category;
            ['fish', 'plants', 'hardscape'].forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                btn.className = (c === category) ? 'active-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition' : 'inactive-tab flex-1 py-2 rounded-lg text-xs font-bold shadow-sm transition';
            });
            renderGrid();
        };

        function renderGrid() {
            grid.innerHTML = '';
            db[currentCategory].forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card bg-white p-3 rounded-xl border border-gray-200 cursor-pointer flex flex-col items-center transition shadow-sm';
                div.innerHTML = `<div class="h-14 w-full flex items-center justify-center mb-2"><img src="${item.img}" class="max-h-full object-contain"></div><span class="text-xs font-semibold text-gray-700">${item.name}</span>`;
                div.onclick = () => addItemToScene(item, currentCategory);
                grid.appendChild(div);
            });
        }
        renderGrid();

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe0e7ff);
        scene.fog = new THREE.Fog(0xe0e7ff, 5, 30);

        const camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 320) / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 3, 8);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth - 320, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxPolarAngle = Math.PI / 2 - 0.1;

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Tank
        const tankGroup = new THREE.Group();
        scene.add(tankGroup);
        // Glass
        const glassMat = new THREE.MeshPhysicalMaterial({ color: 0xaaccff, metalness: 0.1, roughness: 0, transmission: 0.6, transparent: true, side: THREE.BackSide });
        const tank = new THREE.Mesh(new THREE.BoxGeometry(6, 3, 3), glassMat);
        tank.position.y = 1.5;
        tankGroup.add(tank);
        // Sand
        const sand = new THREE.Mesh(new THREE.PlaneGeometry(5.8, 2.8), new THREE.MeshStandardMaterial({ color: 0x2f2f2f }));
        sand.rotation.x = -Math.PI / 2;
        sand.position.y = 0.02;
        sand.receiveShadow = true;
        tankGroup.add(sand);

        // --- TRANSFORM CONTROLS (LOGIC K√âO TH·∫¢) ---
        const transformControl = new TransformControls(camera, renderer.domElement);
        transformControl.setTranslationSnap(0.1); // K√©o gi·∫≠t c·ª•c nh·∫π cho d·ªÖ cƒÉn
        scene.add(transformControl);

        // Khi ƒëang k√©o v·∫≠t th·ªÉ th√¨ t·∫Øt xoay camera (ƒë·ªÉ tr√°nh xoay lo·∫°n)
        transformControl.addEventListener('dragging-changed', function (event) {
            controls.enabled = !event.value;

            // N·∫øu ƒëang k√©o v·∫≠t th·ªÉ, ƒë√°nh d·∫•u n√≥ l√† "ƒëang b·ªã gi·ªØ" ƒë·ªÉ d·ª´ng animation b∆°i
            if (transformControl.object) {
                transformControl.object.userData.isDragging = event.value;
            }
        });

        // --- RAYCASTER (LOGIC CH·ªåN V·∫¨T TH·ªÇ) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // S·ª± ki·ªán click chu·ªôt
        window.addEventListener('pointerdown', (event) => {
            // T√≠nh to√°n v·ªã tr√≠ chu·ªôt trong canvas
            const canvasBounds = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - canvasBounds.left) / canvasBounds.width) * 2 - 1;
            mouse.y = -((event.clientY - canvasBounds.top) / canvasBounds.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(itemsInScene);

            if (intersects.length > 0) {
                // Ch·ªçn v·∫≠t th·ªÉ ƒë·∫ßu ti√™n tia chi·∫øu tr√∫ng
                const selectedObject = intersects[0].object;

                // G·∫Øn c√¥ng c·ª• ƒëi·ªÅu khi·ªÉn v√†o v·∫≠t th·ªÉ ƒë√≥
                transformControl.attach(selectedObject);

                // Hi·ªán thanh c√¥ng c·ª• b√™n d∆∞·ªõi
                document.getElementById('transform-toolbar').style.display = 'flex';
            } else {
                // N·∫øu click ra ngo√†i n·ªÅn -> B·ªè ch·ªçn
                transformControl.detach();
                document.getElementById('transform-toolbar').style.display = 'none';
            }
        });

        // C√°c h√†m ƒëi·ªÅu khi·ªÉn t·ª´ n√∫t HTML
        window.setTransformMode = (mode) => {
            transformControl.setMode(mode); // 'translate' (di chuy·ªÉn) ho·∫∑c 'scale' (co gi√£n)

            // Update UI n√∫t b·∫•m
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');
        }

        window.deleteSelected = () => {
            if (transformControl.object) {
                const obj = transformControl.object;
                transformControl.detach(); // G·ª° c√¥ng c·ª•
                scene.remove(obj); // X√≥a kh·ªèi scene

                // X√≥a kh·ªèi m·∫£ng qu·∫£n l√Ω
                const index = itemsInScene.indexOf(obj);
                if (index > -1) itemsInScene.splice(index, 1);

                document.getElementById('transform-toolbar').style.display = 'none';
            }
        }

        // --- ITEM ADDING LOGIC ---
        const textureLoader = new THREE.TextureLoader();

        window.addItemToScene = (itemData, type) => {
            textureLoader.load(itemData.img, (texture) => {
                const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, side: THREE.DoubleSide, alphaTest: 0.5 });
                const geometry = new THREE.PlaneGeometry(itemData.scale, itemData.scale);
                const mesh = new THREE.Mesh(geometry, material);

                const x = (Math.random() - 0.5) * 4;
                const z = (Math.random() - 0.5) * 2;

                if (type === 'fish') {
                    mesh.position.set(x, Math.random() * 1.5 + 0.5, z);
                    mesh.userData = { isFish: true, speed: (Math.random() * 0.02) + 0.005, direction: Math.random() > 0.5 ? 1 : -1, baseY: mesh.position.y };
                    if (mesh.userData.direction === -1) mesh.scale.x = -1;
                } else {
                    mesh.position.set(x, itemData.scale / 2, z);
                    mesh.userData = { isStatic: true };
                }

                mesh.castShadow = true;
                scene.add(mesh);
                itemsInScene.push(mesh);

                // T·ª± ƒë·ªông ch·ªçn v·∫≠t th·ªÉ m·ªõi th√™m v√†o
                transformControl.attach(mesh);
                document.getElementById('transform-toolbar').style.display = 'flex';
            });
        };

        window.clearScene = () => {
            itemsInScene.forEach(m => scene.remove(m));
            itemsInScene = [];
            transformControl.detach();
            document.getElementById('transform-toolbar').style.display = 'none';
        }

        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            const time = clock.getElapsedTime();

            itemsInScene.forEach(mesh => {
                // N·∫øu v·∫≠t th·ªÉ ƒëang b·ªã k√©o (isDragging) th√¨ KH√îNG ch·∫°y animation b∆°i
                if (!mesh.userData.isDragging) {

                    // Logic C√° b∆°i
                    if (mesh.userData.isFish) {
                        mesh.position.x += mesh.userData.speed * mesh.userData.direction;
                        // C·∫≠p nh·∫≠t baseY li√™n t·ª•c ƒë·ªÉ khi k√©o th·∫£ xong n√≥ b∆°i ti·∫øp ·ªü ƒë·ªô cao m·ªõi
                        if (!transformControl.object || transformControl.object !== mesh) {
                            mesh.position.y = (mesh.position.y * 0.95) + ((mesh.userData.baseY + Math.sin(time * 2 + mesh.id) * 0.1) * 0.05);
                        }

                        // Quay ƒë·∫ßu
                        if (mesh.position.x > 2.8 || mesh.position.x < -2.8) {
                            mesh.userData.direction *= -1;
                            mesh.scale.x *= -1; // L·∫≠t ·∫£nh
                        }
                        mesh.lookAt(camera.position);
                    }

                    // Logic C√¢y/ƒê√° Billboard
                    if (mesh.userData.isStatic) {
                        const target = camera.position.clone();
                        target.y = mesh.position.y;
                        mesh.lookAt(target);
                    }
                } else {
                    // N·∫øu ƒëang k√©o th·∫£, c·∫≠p nh·∫≠t l·∫°i baseY m·ªõi cho c√° ƒë·ªÉ khi th·∫£ ra n√≥ b∆°i ·ªü ch·ªó m·ªõi
                    if (mesh.userData.isFish) {
                        mesh.userData.baseY = mesh.position.y;
                        mesh.lookAt(camera.position); // V·∫´n lu√¥n h∆∞·ªõng v·ªÅ camera khi k√©o
                    }
                    if (mesh.userData.isStatic) {
                        const target = camera.position.clone();
                        target.y = mesh.position.y;
                        mesh.lookAt(target);
                    }
                }
            });

            renderer.render(scene, camera);
        }

        // Resize Handler
        window.addEventListener('resize', () => {
            camera.aspect = (window.innerWidth - 320) / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth - 320, window.innerHeight);
        });

        animate();
    </script>
</body>

</html>